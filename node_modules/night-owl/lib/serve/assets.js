import fs from "node:fs/promises"
import path from "node:path"
import { fileURLToPath } from "node:url"

import compile from "../compilers/pug.js"

const dirname = path.dirname(fileURLToPath(import.meta.url))
const clientFile = path.join(dirname, "client.js")
const templateFile = path.join(dirname, "error.pug")

const templateContent = await fs.readFile(templateFile, "utf-8")
const template = await compile(templateContent, templateFile, {})

export const clientURL = "__nightowl/client.js"

export const client = await fs.readFile(clientFile, "utf-8")

export const appendClient = (html) => {
  return html.replace(
    /(<\/(?:head|body|html)>|$)/,
    `<script type="module" src="/${clientURL}"></script>$1`
  )
}

export const errorPage = (data) => {
  return appendClient(template.render(data))
}
